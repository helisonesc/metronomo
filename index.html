<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metrônomo</title>
  <style>
:root {
--bg: #f8f9fa;
--fg: #212529;
--primary: #007bff;
--danger: #dc3545;
--muted: #6c757d;
}
@media (prefers-color-scheme: dark) {
:root {
--bg: #212529;
--fg: #f8f9fa;
--primary: #66b0ff;
--danger: #ff6b81;
--muted: #adb5bd;
}
}
body {
margin: 0;
font-family: system-ui, sans-serif;
background: var(--bg);
color: var(--fg);
}
.wrap {
max-width: 600px;
margin: auto;
padding: 1rem;
}
h1 {
font-size: 2rem;
margin-bottom: 0.5rem;
}
.btn {
padding: 0.6rem 1rem;
font-size: 1rem;
border: none;
border-radius: 0.5rem;
cursor: pointer;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-muted { background: var(--muted); color: #fff; }
.card { background: rgba(0,0,0,0.03); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem; }
.bpm-display { text-align: center; }
.bpm-number { font-size: 3rem; margin: 0.5rem 0; }
.beat-led { width: 20px; height: 20px; border-radius: 50%; background: var(--muted); margin: auto; }
.beat-led.active { background: var(--primary); }
.grid { display: flex; flex-direction: column; gap: 1rem; }
.row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
.cols-2 { justify-content: space-between; }
.slider { width: 100%; }
.footer { font-size: 0.8rem; color: var(--muted); margin-top: 0.5rem; text-align: center; }
.quick-bpm { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; justify-content: center; }
.fullscreen-btn { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <main class="wrap" role="application" aria-label="Metrônomo">
    <header>
      <h1>Metrônomo</h1>
      <button id="btn-back" class="btn btn-muted" title="Fechar esta aba" aria-label="Retornar">Retornar</button>
    </header>

    <section class="grid">
      <div class="card">
        <div class="bpm-display" aria-live="polite">
          <div class="bpm-number" id="bpmBig">120</div>
          <div class="beat-led" id="beatLed" aria-hidden="true"></div>
        </div>
      </div>

      <div class="card controls">
        <div class="row cols-2">
          <label for="bpmInput">Tempo (BPM)</label>
          <label for="tapBtn" class="muted" style="text-align:right">Tap tempo</label>
          <input type="number" id="bpmInput" min="20" max="300" step="1" value="120" inputmode="numeric" aria-label="Definir BPM" />
          <button id="tapBtn" class="btn btn-muted" aria-label="Tap tempo (toque várias vezes)">TAP</button>
        </div>
        <div class="row">
          <input type="range" id="bpmSlider" class="slider" min="20" max="300" step="1" value="120" aria-label="Controle deslizante de BPM" />
        </div>
        <div class="row cols-2">
          <button id="bpmDownBtn" class="btn btn-muted">-1</button>
          <button id="bpmUpBtn" class="btn btn-muted">+1</button>
        </div>
        <div class="quick-bpm">
          <button class="btn btn-muted quick" data-bpm="60">60</button>
          <button class="btn btn-muted quick" data-bpm="80">80</button>
          <button class="btn btn-muted quick" data-bpm="100">100</button>
          <button class="btn btn-muted quick" data-bpm="120">120</button>
          <button class="btn btn-muted quick" data-bpm="140">140</button>
          <button class="btn btn-muted quick" data-bpm="160">160</button>
        </div>
        <div class="row cols-2">
          <button id="startStopBtn" class="btn btn-primary" aria-pressed="false">Iniciar</button>
          <button id="accentBtn" class="btn btn-muted" title="Alternar acento do primeiro tempo">Acento: Ligado</button>
        </div>
        <div class="row">
          <label for="timeSig">Compasso:</label>
          <select id="timeSig">
            <option value="2">2/4</option>
            <option value="3">3/4</option>
            <option value="4" selected>4/4</option>
            <option value="6">6/8</option>
          </select>
        </div>
        <div class="row fullscreen-btn">
          <button id="fullscreenBtn" class="btn btn-muted">Tela Cheia</button>
        </div>
        <div class="footer">
          <span class="note">Dica: barra de espaço inicia/para • T para Tap</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    const bpmBig = document.getElementById('bpmBig');
    const bpmInput = document.getElementById('bpmInput');
    const bpmSlider = document.getElementById('bpmSlider');
    const tapBtn = document.getElementById('tapBtn');
    const startStopBtn = document.getElementById('startStopBtn');
    const beatLed = document.getElementById('beatLed');
    const backBtn = document.getElementById('btn-back');
    const accentBtn = document.getElementById('accentBtn');
    const bpmUpBtn = document.getElementById('bpmUpBtn');
    const bpmDownBtn = document.getElementById('bpmDownBtn');
    const quickBtns = document.querySelectorAll('.quick');
    const timeSigSelect = document.getElementById('timeSig');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    let audioCtx = null;
    let isRunning = false;
    let nextNoteTime = 0;
    let currentBeat = 0;
    const lookahead = 25;
    const scheduleAheadTime = 0.1;
    let timerID = null;
    let bpm = 120;
    let withAccent = true;
    let beatsPerMeasure = 4;

    function updateBpmDisplay(val){
      bpm = Math.max(20, Math.min(300, Math.round(Number(val) || 0)));
      bpmBig.textContent = bpm;
      bpmInput.value = bpm;
      bpmSlider.value = bpm;
      if(isRunning) {
        nextNoteTime = audioCtx.currentTime + 0.05;
      }
    }

    bpmInput.addEventListener('input', (e)=> updateBpmDisplay(e.target.value));
    bpmSlider.addEventListener('input', (e)=> updateBpmDisplay(e.target.value));
    bpmUpBtn.addEventListener('click', ()=> updateBpmDisplay(bpm+1));
    bpmDownBtn.addEventListener('click', ()=> updateBpmDisplay(bpm-1));
    quickBtns.forEach(btn=> btn.addEventListener('click', ()=> updateBpmDisplay(btn.dataset.bpm)));

    timeSigSelect.addEventListener('change', ()=>{
      beatsPerMeasure = parseInt(timeSigSelect.value);
    });

    const tapTimes = [];
    function registerTap(){
      const now = performance.now();
      while(tapTimes.length && now - tapTimes[0] > 4000) tapTimes.shift();
      tapTimes.push(now);
      if(tapTimes.length >= 2){
        let intervals = [];
        for(let i=1;i<tapTimes.length;i++) intervals.push(tapTimes[i]-tapTimes[i-1]);
        intervals.sort((a,b)=>a-b);
        const keep = intervals.slice(Math.max(0, intervals.length-5));
        const avg = keep.reduce((s,v)=>s+v,0)/keep.length;
        const newBpm = Math.max(20, Math.min(300, Math.round(60000/avg)));
        updateBpmDisplay(newBpm);
      }
      tapBtn.animate([{transform:'scale(1)'},{transform:'scale(0.97)'}],{duration:90, direction:'alternate'});
    }

    tapBtn.addEventListener('click', registerTap);
    document.addEventListener('keydown', (e)=>{
      if(e.code === 'KeyT') { registerTap(); }
      if(e.code === 'Space') { e.preventDefault(); toggle(); }
    });

    function initAudio(){
      if(!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
      }
    }

    function clickSound(time, accented){
      if(!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const freq = accented ? 2000 : 1400;
      osc.frequency.setValueAtTime(freq, time);
      gain.gain.setValueAtTime(0.0001, time);
      gain.gain.exponentialRampToValueAtTime(1.4, time + 0.002);
      gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.06);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(time);
      osc.stop(time + 0.07);
    }

    function scheduler(){
      while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
        const accented = withAccent && (currentBeat % beatsPerMeasure === 0);
        clickSound(nextNoteTime, accented);
        flashLed(nextNoteTime);
        advanceNote();
      }
      timerID = setTimeout(scheduler, lookahead);
    }

    function advanceNote(){
      const secondsPerBeat = 60.0 / bpm;
      nextNoteTime += secondsPerBeat;
      currentBeat++;
    }

    function flashLed(time){
      const now = audioCtx.currentTime;
      const delay = Math.max(0, (time - now) * 1000);
      setTimeout(()=>{
        beatLed.classList.add('active');
        setTimeout(()=> beatLed.classList.remove('active'), 90);
      }, delay);
    }

    function start(){
      initAudio();
      isRunning = true;
      currentBeat = 0;
      nextNoteTime = audioCtx.currentTime + 0.05;
      scheduler();
      startStopBtn.textContent = 'Parar';
      startStopBtn.setAttribute('aria-pressed', 'true');
      startStopBtn.classList.remove('btn-primary');
      startStopBtn.classList.add('btn-danger');
    }

    function stop(){
      isRunning = false;
      if(timerID) clearTimeout(timerID);
      startStopBtn.textContent = 'Iniciar';
      startStopBtn.setAttribute('aria-pressed', 'false');
      startStopBtn.classList.add('btn-primary');
      startStopBtn.classList.remove('btn-danger');
    }

    function toggle(){ isRunning ? stop() : start(); }

    startStopBtn.addEventListener('click', toggle);

    accentBtn.addEventListener('click', ()=>{
      withAccent = !withAccent;
      accentBtn.textContent = `Acento: ${withAccent ? 'Ligado' : 'Desligado'}`;
    });

    backBtn.addEventListener('click', ()=>{
      window.close();
      setTimeout(()=>{ try { history.length > 1 ? history.back() : null; } catch(_){} }, 100);
    });

    fullscreenBtn.addEventListener('click', ()=>{
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    const params = new URLSearchParams(window.location.search);
    if(params.has('bpm')){
      const bpmUrl = parseInt(params.get('bpm'));
      if(!isNaN(bpmUrl)){
        updateBpmDisplay(bpmUrl);
      }
    } else {
      updateBpmDisplay(120);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metrônomo</title>
  <style>
    /* (mantive todo o CSS igual ao anterior) */
  </style>
</head>
<body>
  <main class="wrap" role="application" aria-label="Metrônomo">
    <header>
      <h1>Metrônomo</h1>
      <button id="btn-back" class="btn btn-muted" title="Fechar esta aba" aria-label="Retornar">Retornar</button>
    </header>

    <section class="grid">
      <div class="card">
        <div class="bpm-display" aria-live="polite">
          <div class="bpm-number" id="bpmBig">120</div>
          <div class="beat-led" id="beatLed" aria-hidden="true"></div>
        </div>
      </div>

      <div class="card controls">
        <div class="row cols-2">
          <label for="bpmInput">Tempo (BPM)</label>
          <label for="tapBtn" class="muted" style="text-align:right">Tap tempo</label>
          <input type="number" id="bpmInput" min="20" max="300" step="1" value="120" inputmode="numeric" aria-label="Definir BPM" />
          <button id="tapBtn" class="btn btn-muted" aria-label="Tap tempo (toque várias vezes)">TAP</button>
        </div>
        <div class="row">
          <input type="range" id="bpmSlider" class="slider" min="20" max="300" step="1" value="120" aria-label="Controle deslizante de BPM" />
        </div>
        <div class="row cols-2">
          <button id="startStopBtn" class="btn btn-primary" aria-pressed="false">Iniciar</button>
          <button id="accentBtn" class="btn btn-muted" title="Alternar acento do primeiro tempo">Acento: Ligado</button>
        </div>
        <div class="footer">
          <span class="note">Dica: barra de espaço inicia/para • T para Tap</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    const bpmBig = document.getElementById('bpmBig');
    const bpmInput = document.getElementById('bpmInput');
    const bpmSlider = document.getElementById('bpmSlider');
    const tapBtn = document.getElementById('tapBtn');
    const startStopBtn = document.getElementById('startStopBtn');
    const beatLed = document.getElementById('beatLed');
    const backBtn = document.getElementById('btn-back');
    const accentBtn = document.getElementById('accentBtn');

    let audioCtx = null;
    let isRunning = false;
    let nextNoteTime = 0;
    let currentBeat = 0;
    const lookahead = 25;
    const scheduleAheadTime = 0.1;
    let timerID = null;
    let bpm = 120;
    let withAccent = true;

    function updateBpmDisplay(val){
      bpm = Math.max(20, Math.min(300, Math.round(Number(val) || 0)));
      bpmBig.textContent = bpm;
      bpmInput.value = bpm;
      bpmSlider.value = bpm;
      if(isRunning) {
        nextNoteTime = audioCtx.currentTime + 0.05;
      }
    }

    bpmInput.addEventListener('input', (e)=> updateBpmDisplay(e.target.value));
    bpmSlider.addEventListener('input', (e)=> updateBpmDisplay(e.target.value));

    const tapTimes = [];
    function registerTap(){
      const now = performance.now();
      while(tapTimes.length && now - tapTimes[0] > 4000) tapTimes.shift();
      tapTimes.push(now);
      if(tapTimes.length >= 2){
        let intervals = [];
        for(let i=1;i<tapTimes.length;i++) intervals.push(tapTimes[i]-tapTimes[i-1]);
        intervals.sort((a,b)=>a-b);
        const keep = intervals.slice(Math.max(0, intervals.length-5));
        const avg = keep.reduce((s,v)=>s+v,0)/keep.length;
        const newBpm = Math.max(20, Math.min(300, Math.round(60000/avg)));
        updateBpmDisplay(newBpm);
      }
      tapBtn.animate([{transform:'scale(1)'},{transform:'scale(0.97)'}],{duration:90, direction:'alternate'});
    }

    tapBtn.addEventListener('click', registerTap);
    document.addEventListener('keydown', (e)=>{
      if(e.code === 'KeyT') { registerTap(); }
      if(e.code === 'Space') { e.preventDefault(); toggle(); }
    });

    function initAudio(){
      if(!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
      }
    }

    function clickSound(time, accented){
      if(!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const freq = accented ? 2000 : 1400;
      osc.frequency.setValueAtTime(freq, time);
      gain.gain.setValueAtTime(0.0001, time);
      gain.gain.exponentialRampToValueAtTime(0.7, time + 0.002);
      gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.06);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(time);
      osc.stop(time + 0.07);
    }

    function scheduler(){
      while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
        const accented = withAccent && (currentBeat % 4 === 0);
        clickSound(nextNoteTime, accented);
        flashLed(nextNoteTime);
        advanceNote();
      }
      timerID = setTimeout(scheduler, lookahead);
    }

    function advanceNote(){
      const secondsPerBeat = 60.0 / bpm;
      nextNoteTime += secondsPerBeat;
      currentBeat++;
    }

    function flashLed(time){
      const now = audioCtx.currentTime;
      const delay = Math.max(0, (time - now) * 1000);
      setTimeout(()=>{
        beatLed.classList.add('active');
        setTimeout(()=> beatLed.classList.remove('active'), 90);
      }, delay);
    }

    function start(){
      initAudio();
      isRunning = true;
      currentBeat = 0;
      nextNoteTime = audioCtx.currentTime + 0.05;
      scheduler();
      startStopBtn.textContent = 'Parar';
      startStopBtn.setAttribute('aria-pressed', 'true');
      startStopBtn.classList.remove('btn-primary');
      startStopBtn.classList.add('btn-danger');
    }

    function stop(){
      isRunning = false;
      if(timerID) clearTimeout(timerID);
      startStopBtn.textContent = 'Iniciar';
      startStopBtn.setAttribute('aria-pressed', 'false');
      startStopBtn.classList.add('btn-primary');
      startStopBtn.classList.remove('btn-danger');
    }

    function toggle(){ isRunning ? stop() : start(); }

    startStopBtn.addEventListener('click', toggle);

    accentBtn.addEventListener('click', ()=>{
      withAccent = !withAccent;
      accentBtn.textContent = `Acento: ${withAccent ? 'Ligado' : 'Desligado'}`;
    });

    backBtn.addEventListener('click', ()=>{
      window.close();
      setTimeout(()=>{ try { history.length > 1 ? history.back() : null; } catch(_){} }, 100);
    });

    // ====== Novo: BPM via URL ======
    const params = new URLSearchParams(window.location.search);
    if(params.has('bpm')){
      const bpmUrl = parseInt(params.get('bpm'));
      if(!isNaN(bpmUrl)){
        updateBpmDisplay(bpmUrl);
      }
    } else {
      updateBpmDisplay(120);
    }
  </script>
</body>
</html>
